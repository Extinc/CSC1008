{% extends 'base/main.html' %}
{% load static %}
{% block content %}

    <body>

    {% if request.user.is_authenticated %}

        <form action="" method="POST" id="test">
            {% csrf_token %}


            <div class="row">
                <div class="card mx-auto fixed-top col-md-5 col-sm-5 col-10" style="margin-top:1.4rem;">
                    <div class="card-body container" style="padding-left: 0; padding-right: 0;">
                        <div class="row">
                            <div class="d-flex align-items-center justify-content-center col-sm-2 col-2">
                                <button type="button"
                                        data-bs-toggle="offcanvas"
                                        data-bs-target="#offcanvasScrolling" aria-controls="offcanvasScrolling"
                                        class="lift_navbar_btn1">
                                    <i class="fa-solid fa-bars lift_navbar_icon2"></i>
                                </button>
                            </div>
                            <div class="col mr-auto">
                                <div class="row ">
                                    <div id="input-group">

                                        <input
                                                type="search"
                                                class="form-control rounded autocomplete"
                                                id="startlocation"
                                                placeholder="Start"
                                                aria-label="Search"
                                                aria-describedby="search-addon"
                                        />
                                    </div>

                                </div>
                                <div class="row pt-3">
                                    <div class="input-group">
                                        <input
                                                type="search"
                                                class="form-control rounded"
                                                id="endlocation"
                                                placeholder="End"
                                                aria-label="Search"
                                                aria-describedby="search-addon"
                                        />
                                    </div>
                                </div>
                            </div>
                            <div class="d-flex align-items-center justify-content-center col-sm-2 col-2">
                                <button type="button" class="lift_navbar_btn1">
                                    <i class="fa-solid fa-magnifying-glass lift_navbar_icon"></i>
                                </button>
                            </div>
                        </div>

                    </div>

                </div>
            </div>
            <div class="offcanvas offcanvas-start" data-bs-scroll="true" data-bs-backdrop="false" tabindex="-1"
                 id="offcanvasScrolling" aria-labelledby="offcanvasScrollingLabel">

                <div class="d-flex flex-column flex-shrink-0 p-3 text-white bg-dark w-100 h-100">
                    <div class="d-flex align-items-center justify-content-center">
                        <a href="/index">
                            <img src="{% static '/logo1.svg' %}" alt="logo1" style="height:100%">
                        </a>
                    </div>
                    <hr>
                    <ul class="nav nav-pills flex-column mb-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link active" aria-current="page">
                                <i class="fa-regular fa-house bi me-2"></i>
                                Home
                            </a>
                        </li>
                        <li>
                            <a href="#" class="nav-link text-white" style="background: transparent ">
                                <i class="fa-solid fa-flask-vial bi me-2"></i>
                                TEST
                            </a>
                        </li>
                    </ul>
                    <hr>
                    <div class="drop down">
                        <a href="#" class="d-flex align-items-center text-white text-decoration-none dropdown-toggle"
                           id="dropdownUser1" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fa-solid fa-user rounded-circle me-2"></i>
                            <strong>ACCOUNT</strong>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-dark text-small shadow" aria-labelledby="dropdownUser1">
                            <li>
                                <hr class="dropdown-divider">
                            </li>
                            <li><a class="dropdown-item" href="/signout">Sign out</a></li>
                        </ul>
                    </div>
                </div>
            </div>

            <div id="map" style="position:absolute; width: 100%; height: 100%; "></div>
            <div class="row">

                <div class="accordion position-fixed fixed-bottom mb-4 col-md-5 col-sm-5 col-10 mx-auto"
                     id="accordionPanelsStayOpenExample">
                    <div class="accordion-item">
                        <div id="panelsStayOpen-collapseOne" class="accordion-collapse collapse show"
                             aria-labelledby="headingOne">
                            <div class="accordion-body">
                                <strong>This is the first item's accordion body.</strong> It is shown by default,
                                until the collapse plugin adds the appropriate classes that we use to style each
                                element. These classes control the overall appearance, as well as the showing and
                                hiding via CSS transitions. You can modify any of this with custom CSS or overriding
                                our default variables. It's also worth noting that just about any HTML can go within
                                the <code>.accordion-body</code>, though the transition does limit overflow.
                            </div>
                        </div>
                        <h2 class="accordion-header" id="headingOne">
                            <button class="accordion-button" type="button" data-mdb-toggle="collapse"
                                    data-mdb-target="#panelsStayOpen-collapseOne" aria-expanded="true"
                                    aria-controls="panelsStayOpen-collapseOne">
                                Current Ride
                            </button>
                        </h2>

                    </div>

                </div>
            </div>
            <input type="hidden" name="" id="hiddenstart">
            <input type="hidden" name="" id="hiddenend">
        </form>

        <script>
            $("#startlocation").autocomplete({
                minLength: 1,
                source: function (request, response, url) {
                    var searchParam = request.term;
                    $.ajax({
                        url: '/get_addr/?search=' + request.term,
                        data: searchParam,
                        dataType: "json",
                        type: "GET",
                        cache: true,
                        success: function (data) {
                            response($.map(data, function (item, index) {
                                return {
                                    label: item,
                                    value: item,
                                    nodeid: index
                                };
                            }));
                        }
                    });//ajax ends
                },
                select: function (a, b) {
                    $("#hiddenstart").val(b.item.nodeid)
                    {#console.log("SELECT " + );#}

                    // Appends an array with 2 keys: Value and Label.
                    // Both display the title and date as shown above.
                }
            }).data("ui-autocomplete")._renderItem = function (ul, item) {
                const htmlstring = `<li class="ui-menu-item"><div class="ui-menu-item-wrapper" tabindex="-1"></div></li>`;
                const $li = $(htmlstring);
                const id = $(ul).find('li').length + 1;
                $li.find('div').attr("data-id", item.nodeid).attr("id", id).html(item.label);
                return $li.appendTo(ul);
            };

            $("#endlocation").autocomplete({
                minLength: 1,
                source: function (request, response, url) {
                    var searchParam = request.term;
                    $.ajax({
                        url: '/get_addr/?search=' + request.term,
                        data: searchParam,
                        dataType: "json",
                        type: "GET",
                        cache: true,
                        success: function (data) {
                            response($.map(data, function (item, index) {
                                return {
                                    label: item,
                                    value: item,
                                    nodeid: index
                                };
                            }));
                        }
                    });//ajax ends
                },
                select: function (a, b) {
                    $("#hiddenend").val(b.item.nodeid)
                    {#console.log("SELECT " + );#}

                    // Appends an array with 2 keys: Value and Label.
                    // Both display the title and date as shown above.
                }
            }).data("ui-autocomplete")._renderItem = function (ul, item) {
                const htmlstring = `<li class="ui-menu-item"><div class="ui-menu-item-wrapper" tabindex="-1"></div></li>`;
                const $li = $(htmlstring);
                const id = $(ul).find('li').length + 1;
                $li.find('div').attr("data-id", item.nodeid).attr("id", id).html(item.label);
                return $li.appendTo(ul);
            };

            var latitude = 0;
            var longitude = 0;
            var map;
            mapboxgl.accessToken = "{{ mapbox_key }}";
            if ("geolocation" in navigator) {
                navigator.geolocation.getCurrentPosition(position => {

                    map = new mapboxgl.Map({
                        container: "map",
                        pitch: 45,
                        center: [position.coords.longitude, position.coords.latitude],
                        zoom: 17, // starting zoom
                        style: "mapbox://styles/exkingist/cl0s7xq5v001i14n5vioj61u5",
                    });
                    $.ajax({
                        type: "GET",
                        url: "/findnearest/",
                        cache: true,
                        data: {
                            'lat': position.coords.latitude,
                            'long': position.coords.longitude
                        }, success: function (result) {
                            const data = JSON.parse(result["data"]);
                            console.log(data);
                            for (var i = 0; i < data.length; i++) {
                                var obj = data[i];
                                if(obj.POSTALCODE === 'NIL'){
                                    var marker = new mapboxgl.Marker()
                                        .setLngLat([obj.long, obj.lat])
                                        .setPopup(new mapboxgl.Popup().setHTML("<h id='nodebuilding'>" + obj.BUILDINGNAME + "</h><p id='nodeidhidden' class='d-none'>" + obj.id + "</p>"))
                                        .addTo(map);
                                }else{
                                    var marker = new mapboxgl.Marker()
                                        .setLngLat([obj.long, obj.lat])
                                        .setPopup(new mapboxgl.Popup().setHTML("<h id='nodebuilding'>" + obj.BUILDINGNAME + "</h><p> "+ obj.POSTALCODE + "</p> <p  id='nodeidhidden'  class='d-none'>" + obj.id + "</p>"))
                                        .addTo(map);
                                }


                            }
                        }
                    });
                    map.addControl(new mapboxgl.NavigationControl(), 'bottom-left');
                    const geolocate = new mapboxgl.GeolocateControl({
                        positionOptions: {
                            enableHighAccuracy: true,
                        },
                        trackUserLocation: true
                    });
                    map.addControl(geolocate, 'bottom-left');

                    // Used to Get lat and longitude coordinates
                    // TODO: USE THIS LOCATION when user press.
                    geolocate.on('geolocate', function (position) {
                        latitude = position.coords.latitude;
                        longitude = position.coords.longitude;
                    });


                    map.on('load', () => {
                        // Insert the layer beneath any symbol layer.
                        map.resize();
                        const layers = map.getStyle().layers;
                        const labelLayerId = layers.find(
                            (layer) => layer.type === 'symbol' && layer.layout['text-field']
                        ).id;

                        // The 'building' layer in the Mapbox Streets
                        // vector tileset contains building height data
                        // from OpenStreetMap.
                        map.addLayer(
                            {
                                'id': 'add-3d-buildings',
                                'source': 'composite',
                                'source-layer': 'building',
                                'filter': ['==', 'extrude', 'true'],
                                'type': 'fill-extrusion',
                                'minzoom': 15,
                                'paint': {
                                    'fill-extrusion-color': '#aaa',
                                    // Use an 'interpolate' expression to
                                    // add a smooth transition effect to
                                    // the buildings as the user zooms in.
                                    'fill-extrusion-height': [
                                        'interpolate',
                                        ['linear'],
                                        ['zoom'],
                                        15,
                                        0,
                                        15.05,
                                        ['get', 'height']
                                    ],
                                    'fill-extrusion-base': [
                                        'interpolate',
                                        ['linear'],
                                        ['zoom'],
                                        15,
                                        0,
                                        15.05,
                                        ['get', 'min_height']
                                    ],
                                    'fill-extrusion-opacity': 0.6
                                }
                            },
                            labelLayerId
                        );
                        map.resize();
                    });


                });
            }

            $(document).on('click', '.mapboxgl-marker', function () {
                var node_id = $("#nodeidhidden");
                var node_text =$('#nodebuilding');
                $("#hiddenstart").val(node_id.text());
                $("#startlocation").val(node_text.text());
            });

        </script>
        <style>
            .ui-autocomplete {
                z-index: 1030;
            }
        </style>
    {% endif %}
    </body>
{% endblock content %}
