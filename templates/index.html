{% extends 'base/main.html' %} {% block content %}

    <body>
    {% include 'base/navbar.html' %} {% if request.user.is_authenticated %}

        <form action="" method="POST" id="test">
            {% csrf_token %}
            {#            <div id="map" style="width: 1500px; height: 1000px"></div>#}

        </form>
        <div>
            <div>
                <input id="searchaddress" name="" >
            </div>
            <div id="map" style=" position: absolute; width: 100%; height: 90vh; "></div>
        </div>
        <script>

            mapboxgl.accessToken = "{{ mapbox_key }}";
            var map = new mapboxgl.Map({
                container: "map",
                pitch: 45,
                center: [103.84042953664608, 1.3593394625724913],
                zoom: 13, // starting zoom
                style: "mapbox://styles/exkingist/cl0s7xq5v001i14n5vioj61u5",
            });
            const geolocate = new mapboxgl.GeolocateControl({
                positionOptions: {
                    enableHighAccuracy: true,
                },
                trackUserLocation: true
            });
            map.addControl(geolocate);

            // Used to Get lat and longitude coordinates
            // TODO: USE THIS LOCATION when user press.
            geolocate.on('geolocate', function (position) {
                const latitude = position.coords.latitude;
                const longitude = position.coords.longitude;
                console.log('lat, lng', latitude, longitude);
            });

            map.on('load', () => {
                // Insert the layer beneath any symbol layer.

                const layers = map.getStyle().layers;
                const labelLayerId = layers.find(
                    (layer) => layer.type === 'symbol' && layer.layout['text-field']
                ).id;

                // The 'building' layer in the Mapbox Streets
                // vector tileset contains building height data
                // from OpenStreetMap.
                map.addLayer(
                    {
                        'id': 'add-3d-buildings',
                        'source': 'composite',
                        'source-layer': 'building',
                        'filter': ['==', 'extrude', 'true'],
                        'type': 'fill-extrusion',
                        'minzoom': 15,
                        'paint': {
                            'fill-extrusion-color': '#aaa',

                            // Use an 'interpolate' expression to
                            // add a smooth transition effect to
                            // the buildings as the user zooms in.
                            'fill-extrusion-height': [
                                'interpolate',
                                ['linear'],
                                ['zoom'],
                                15,
                                0,
                                15.05,
                                ['get', 'height']
                            ],
                            'fill-extrusion-base': [
                                'interpolate',
                                ['linear'],
                                ['zoom'],
                                15,
                                0,
                                15.05,
                                ['get', 'min_height']
                            ],
                            'fill-extrusion-opacity': 0.6
                        }
                    },
                    labelLayerId
                );
                 map.resize();
            });

            function plot_route() {
                $.post(
                    "/plot_route/",
                    {
                        reply: false,
                        csrfmiddlewaretoken: $('input[name="csrfmiddlewaretoken"]').val(),
                    },
                    function (data) {
                        //{ #console.log(data['coordinates']); }
                        map.addSource("route", {
                            type: "geojson",
                            data: {
                                type: "Feature",
                                properties: {},
                                geometry: data,
                            },
                        });

                        map.addLayer({
                            id: "route",
                            type: "line",
                            source: "route",
                            layout: {
                                "line-join": "round",
                                "line-cap": "round",
                            },
                            paint: {
                                "line-color": "#ee2323",
                                "line-width": 8,
                            },
                        });
                    }
                );
            }

            $("#searchaddress").keyup(function(){
                $.ajax({
                    type: "GET",
                    url: "/get_addr",
                    data:{
                        "search": $("#searchaddress").val()
                    }, success: function(response){

                    }
                })
            });
        </script>

    {% endif %}
    </body>
{% endblock content %}
