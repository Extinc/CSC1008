{% extends 'base/main.html' %}
{% load static %}
{% block content %}

    <body>
    {% if request.user.is_authenticated %}

        <form action="" method="POST" id="test">
            {% csrf_token %}


            <div class="row">
                <div class="card mx-auto $zindex-popover fixed-top col-md-6 col-10" style="margin-top:5rem;">
                    <div class="card-body container">
                        <div class="row">
                            <div class="d-flex align-items-center justify-content-center col-sm-2 col-2">
                                <button class="btn btn-primary fa-solid fa-bars" type="button"
                                        data-bs-toggle="offcanvas"
                                        data-bs-target="#offcanvasScrolling" aria-controls="offcanvasScrolling">
                                </button>
                            </div>
                            <div class="col mr-auto">
                                <div class="row ">
                                    <div class="input-group mb-3">

                                        <input
                                                type="search"
                                                class="form-control rounded"
                                                placeholder="Start"
                                                aria-label="Search"
                                                aria-describedby="search-addon"
                                        />
                                    </div>
                                </div>
                                <div class="row pt-2">
                                    <div class="input-group mb-3">

                                        <input
                                                type="search"
                                                class="form-control rounded"
                                                placeholder="End"
                                                aria-label="Search"
                                                aria-describedby="search-addon"
                                        />
                                    </div>
                                </div>
                            </div>

                        </div>

                    </div>

                </div>
            </div>
            <div class="offcanvas offcanvas-start" data-bs-scroll="true" data-bs-backdrop="false" tabindex="-1"
                 id="offcanvasScrolling" aria-labelledby="offcanvasScrollingLabel">

                <div class="d-flex flex-column flex-shrink-0 p-3 text-white bg-dark w-100 h-100">
                    <div class="d-flex align-items-center justify-content-center">
                        <a href="/index">
                            <img src="{% static '/logo1.svg' %}" alt="logo1" style="height:100%">
                        </a>
                    </div>
                    <hr>
                    <ul class="nav nav-pills flex-column mb-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link active" aria-current="page">
                                <i class="fa-regular fa-house bi me-2"></i>
                                Home
                            </a>
                        </li>
                        <li>
                            <a href="#" class="nav-link text-white" style="background: transparent ">
                                <i class="fa-solid fa-flask-vial bi me-2"></i>
                                TEST
                            </a>
                        </li>
                    </ul>
                    <hr>
                    <div class="dropdown">
                        <a href="#" class="d-flex align-items-center text-white text-decoration-none dropdown-toggle"
                           id="dropdownUser1" data-bs-toggle="dropdown" aria-expanded="false">
                            <img src=".." alt="" width="32" height="32"
                                 class="rounded-circle me-2">
                            <strong>ACCOUNT</strong>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-dark text-small shadow" aria-labelledby="dropdownUser1">
                            <li><a class="dropdown-item" href="#">New project...</a></li>
                            <li><a class="dropdown-item" href="#">Settings</a></li>
                            <li><a class="dropdown-item" href="#">Profile</a></li>
                            <li>
                                <hr class="dropdown-divider">
                            </li>
                            <li><a class="dropdown-item" href="/signout">Sign out</a></li>
                        </ul>
                    </div>
                </div>
            </div>

            <div id="map" style="position:absolute; width: 100%; height: 100%; "></div>
        </form>

        <script>
            var latitude = 0;
            var longitude = 0;
            var map;
            mapboxgl.accessToken = "{{ mapbox_key }}";
            if ("geolocation" in navigator) {
                navigator.geolocation.getCurrentPosition(position => {

                    map = new mapboxgl.Map({
                        container: "map",
                        pitch: 45,
                        center: [position.coords.longitude, position.coords.latitude],
                        zoom: 17, // starting zoom
                        style: "mapbox://styles/exkingist/cl0s7xq5v001i14n5vioj61u5",
                    });
                    $.ajax({
                        type: "GET",
                        url: "/findnearest/",
                        data: {
                            'lat': position.coords.latitude,
                            'long': position.coords.longitude
                        }, success: function (result) {
                            const data = JSON.parse(result["data"]);
                            console.log(data);
                            for (var i = 0; i < data.length; i++) {
                                var obj = data[i];

                                var marker = new mapboxgl.Marker()
                                    .setLngLat([obj.long, obj.lat])
                                    .setPopup(new mapboxgl.Popup().setHTML("<p>" + obj.id + "</p>"))
                                    .addTo(map);
                            }
                        }
                    });
                    map.addControl(new mapboxgl.NavigationControl(), 'bottom-left');
                    const geolocate = new mapboxgl.GeolocateControl({
                        positionOptions: {
                            enableHighAccuracy: true,
                        },
                        trackUserLocation: true
                    });
                    map.addControl(geolocate, 'bottom-left');

                    // Used to Get lat and longitude coordinates
                    // TODO: USE THIS LOCATION when user press.
                    geolocate.on('geolocate', function (position) {
                        latitude = position.coords.latitude;
                        longitude = position.coords.longitude;
                    });


                    map.on('load', () => {
                        // Insert the layer beneath any symbol layer.
                        map.resize();
                        const layers = map.getStyle().layers;
                        const labelLayerId = layers.find(
                            (layer) => layer.type === 'symbol' && layer.layout['text-field']
                        ).id;

                        // The 'building' layer in the Mapbox Streets
                        // vector tileset contains building height data
                        // from OpenStreetMap.
                        map.addLayer(
                            {
                                'id': 'add-3d-buildings',
                                'source': 'composite',
                                'source-layer': 'building',
                                'filter': ['==', 'extrude', 'true'],
                                'type': 'fill-extrusion',
                                'minzoom': 15,
                                'paint': {
                                    'fill-extrusion-color': '#aaa',
                                    // Use an 'interpolate' expression to
                                    // add a smooth transition effect to
                                    // the buildings as the user zooms in.
                                    'fill-extrusion-height': [
                                        'interpolate',
                                        ['linear'],
                                        ['zoom'],
                                        15,
                                        0,
                                        15.05,
                                        ['get', 'height']
                                    ],
                                    'fill-extrusion-base': [
                                        'interpolate',
                                        ['linear'],
                                        ['zoom'],
                                        15,
                                        0,
                                        15.05,
                                        ['get', 'min_height']
                                    ],
                                    'fill-extrusion-opacity': 0.6
                                }
                            },
                            labelLayerId
                        );
                        map.resize();
                    });


                });
            }


            $(document).ready(function () {
                {#geolocate.trigger();#}
                console.log(latitude)
            });


            $("#searchaddress").keyup(function () {
                $.ajax({
                    type: "GET",
                    url: "/get_addr",
                    data: {
                        "search": $("#searchaddress").val()
                    }, success: function (response) {

                    }
                })
            });
        </script>

    {% endif %}
    </body>
{% endblock content %}
